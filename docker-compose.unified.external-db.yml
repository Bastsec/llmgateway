name: llmgateway-unified-vm

services:
  postgres:
    container_name: llmgateway-postgres
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pw}
      POSTGRES_DB: ${POSTGRES_DB:-llmgateway}
    volumes:
      - llmgateway_postgres:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-llmgateway}",
        ]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    container_name: llmgateway-redis
    image: redis:8
    command: ["redis-server", "--protected-mode", "yes", "--bind", "0.0.0.0"]
    restart: unless-stopped
    volumes:
      - llmgateway_redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 20

  llmgateway:
    build:
      context: .
      dockerfile: infra/unified.external-db.dockerfile
    container_name: llmgateway-local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3002:3002" # UI
      - "3003:3003" # Playground
      - "3005:3005" # Docs
      - "4001:4001" # Gateway
      - "4002:4002" # API
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL}
      # Redis
      REDIS_URL: ${REDIS_URL}
      # URLs
      UI_URL: ${UI_URL}
      PLAYGROUND_URL: ${PLAYGROUND_URL}
      API_URL: ${API_URL}
      API_BACKEND_URL: ${API_BACKEND_URL}
      ORIGIN_URLS: ${ORIGIN_URLS}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN}
      # Authentication
      PASSKEY_RP_ID: ${PASSKEY_RP_ID}
      PASSKEY_RP_NAME: ${PASSKEY_RP_NAME}
      AUTH_SECRET: ${AUTH_SECRET}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      # Analytics (optional)
      POSTHOG_KEY: ${POSTHOG_KEY}
      POSTHOG_HOST: ${POSTHOG_HOST}
      # Stripe (optional)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_PRO_MONTHLY_PRICE_ID: ${STRIPE_PRO_MONTHLY_PRICE_ID}
      STRIPE_PRO_YEARLY_PRICE_ID: ${STRIPE_PRO_YEARLY_PRICE_ID}
      # LLM Provider API Keys
      LLM_OPENAI_API_KEY: ${LLM_OPENAI_API_KEY}
      LLM_ANTHROPIC_API_KEY: ${LLM_ANTHROPIC_API_KEY}
      # Azure OpenAI (optional)
      LLM_AZURE_API_KEY: ${LLM_AZURE_API_KEY}
      LLM_AZURE_RESOURCE: ${LLM_AZURE_RESOURCE}
      LLM_AZURE_API_VERSION: ${LLM_AZURE_API_VERSION}
      LLM_AZURE_DEPLOYMENT_TYPE: ${LLM_AZURE_DEPLOYMENT_TYPE}
      # Migrations
      RUN_MIGRATIONS: "true"

volumes:
  llmgateway_postgres:
    driver: local
  llmgateway_redis:
    driver: local
